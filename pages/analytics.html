<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="UserHub - Analytics Dashboard">
    <title>Analytics - UserHub Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">ðŸ‘¥</span>
                    <span class="logo-text">UserHub</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </button>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="../index.html">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" />
                                <rect x="14" y="3" width="7" height="7" />
                                <rect x="14" y="14" width="7" height="7" />
                                <rect x="3" y="14" width="7" height="7" />
                            </svg><span>Dashboard</span></a></li>
                    <li><a href="users.html">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg><span>Users</span></a></li>
                    <li class="active"><a href="analytics.html">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10" />
                                <line x1="12" y1="20" x2="12" y2="4" />
                                <line x1="6" y1="20" x2="6" y2="14" />
                            </svg><span>Analytics</span></a></li>
                    <li><a href="roles.html">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                            </svg><span>Roles</span></a></li>
                    <li><a href="settings.html">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                            </svg><span>Settings</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">OG</div>
                    <div class="user-details">
                        <span class="user-name">Omar Gad</span>
                        <span class="user-role">Administrator</span>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn" title="Logout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12" />
                            <line x1="3" y1="6" x2="21" y2="6" />
                            <line x1="3" y1="18" x2="21" y2="18" />
                        </svg>
                    </button>
                    <div class="page-title">
                        <h1>Analytics</h1>
                        <p>User statistics and insights</p>
                    </div>
                </div>
            </header>

            <!-- Stats Section -->
            <section class="stats-section">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <h3>Total Users</h3>
                        <p class="stat-number" id="totalUsers">0</p>
                        <span class="stat-change positive">All registered users</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                            <polyline points="22 4 12 14.01 9 11.01" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <h3>Active Users</h3>
                        <p class="stat-number" id="activeUsers">0</p>
                        <span class="stat-change positive">Currently active</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="8" x2="12" y2="12" />
                            <line x1="12" y1="16" x2="12.01" y2="16" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <h3>Pending Users</h3>
                        <p class="stat-number" id="pendingUsers">0</p>
                        <span class="stat-change negative">Awaiting approval</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <h3>New This Month</h3>
                        <p class="stat-number" id="newUsers">0</p>
                        <span class="stat-change positive">Monthly signups</span>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Monthly User Trends</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyTrendsChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Users by Role</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="rolesChart"></canvas>
                    </div>
                </div>
            </section>

            <section class="charts-section" style="margin-top: 20px;">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>User Growth</h3>
                        <select id="growthPeriod">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Users by Status</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="table-section" style="margin-top: 20px;">
                <div class="table-header">
                    <h2>Recent Activity</h2>
                </div>
                <div style="padding: 20px;">
                    <div id="activityList"></div>
                </div>
            </section>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        let monthlyChart, rolesChart, growthChart, statusChart;

        document.addEventListener('DOMContentLoaded', async () => {
            await auth.init();
            setupEventListeners();
            loadAnalytics();
        });

        function setupEventListeners() {
            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            mobileMenuBtn.addEventListener('click', () => sidebar.classList.toggle('mobile-open'));
            logoutBtn.addEventListener('click', () => auth.logout());
            document.getElementById('growthPeriod').addEventListener('change', (e) => loadGrowthChart(e.target.value));
        }

        async function loadAnalytics() {
            try {
                const [statsRes, trendsRes, rolesRes, statusRes, activityRes] = await Promise.all([
                    api.getStats(),
                    api.getMonthlyTrends(),
                    api.getRolesDistribution(),
                    api.getStatusDistribution(),
                    api.getRecentActivity()
                ]);

                // Update stats
                const stats = statsRes.stats;
                document.getElementById('totalUsers').textContent = stats.totalUsers.toLocaleString();
                document.getElementById('activeUsers').textContent = stats.activeUsers.toLocaleString();
                document.getElementById('pendingUsers').textContent = stats.pendingUsers.toLocaleString();
                document.getElementById('newUsers').textContent = stats.newUsersThisMonth.toLocaleString();

                // Monthly trends chart
                if (monthlyChart) monthlyChart.destroy();
                monthlyChart = new Chart(document.getElementById('monthlyTrendsChart'), {
                    type: 'bar',
                    data: {
                        labels: trendsRes.trends.labels,
                        datasets: [{
                            label: 'New Users',
                            data: trendsRes.trends.data,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderRadius: 6
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // Roles chart
                if (rolesChart) rolesChart.destroy();
                rolesChart = new Chart(document.getElementById('rolesChart'), {
                    type: 'doughnut',
                    data: {
                        labels: rolesRes.distribution.map(d => d.name),
                        datasets: [{
                            data: rolesRes.distribution.map(d => d.count),
                            backgroundColor: rolesRes.distribution.map(d => d.color),
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom' } } }
                });

                // Status chart
                if (statusChart) statusChart.destroy();
                statusChart = new Chart(document.getElementById('statusChart'), {
                    type: 'pie',
                    data: {
                        labels: statusRes.distribution.map(d => d.name),
                        datasets: [{
                            data: statusRes.distribution.map(d => d.count),
                            backgroundColor: statusRes.distribution.map(d => d.color),
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                // Load growth chart
                loadGrowthChart(30);

                // Activity list
                const activityHtml = activityRes.activities.map(a => `
                    <div style="display: flex; align-items: center; gap: 14px; padding: 14px 0; border-bottom: 1px solid var(--border-color);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: ${a.user.avatar}; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; color: white;">
                            ${a.user.name.split(' ').map(n => n[0]).join('')}
                        </div>
                        <div style="flex: 1;">
                            <p style="font-weight: 500; margin-bottom: 4px;">${a.message}</p>
                            <p style="font-size: 0.8125rem; color: var(--text-muted);">${formatDate(a.timestamp)}</p>
                        </div>
                    </div>
                `).join('');
                document.getElementById('activityList').innerHTML = activityHtml || '<p style="color: var(--text-muted);">No recent activity</p>';

            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        async function loadGrowthChart(period) {
            try {
                const res = await api.getUserGrowth(period);
                if (growthChart) growthChart.destroy();
                growthChart = new Chart(document.getElementById('userGrowthChart'), {
                    type: 'line',
                    data: {
                        labels: res.growth.labels,
                        datasets: [{
                            label: 'New Users',
                            data: res.growth.data,
                            borderColor: '#8B5CF6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            } catch (error) {
                console.error('Failed to load growth chart:', error);
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
    </script>
</body>

</html>